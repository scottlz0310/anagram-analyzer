name: Android Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "リリースタグ (例: v0.2.0 / 未指定時は自動生成)"
        required: false
        type: string
      release_name:
        description: "リリース名（未指定時はタグ名）"
        required: false
        type: string
      prerelease:
        description: "プレリリースとして公開する"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release:
    name: Build & Publish Android Release
    if: github.event_name != 'push' || github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Resolve release metadata
        id: meta
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
          INPUT_NAME: ${{ github.event.inputs.release_name }}
          INPUT_PRERELEASE: ${{ github.event.inputs.prerelease }}
          REF_NAME: ${{ github.ref_name }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            SANITIZED_REF="${REF_NAME//\//-}"
            TAG="${INPUT_TAG:-v0.0.0-auto-${SANITIZED_REF}-${RUN_ID}}"
            NAME="${INPUT_NAME:-$TAG}"
            PRERELEASE="${INPUT_PRERELEASE}"
            CHECKOUT_REF="${REF_NAME}"
          else
            TAG="${REF_NAME}"
            NAME="${REF_NAME}"
            PRERELEASE="false"
            CHECKOUT_REF="${REF_NAME}"
          fi
          {
            printf 'tag<<EOF\n%s\nEOF\n' "${TAG}"
            printf 'name<<EOF\n%s\nEOF\n' "${NAME}"
            printf 'prerelease<<EOF\n%s\nEOF\n' "${PRERELEASE}"
            printf 'checkout_ref<<EOF\n%s\nEOF\n' "${CHECKOUT_REF}"
          } >> "${GITHUB_OUTPUT}"

      - name: Checkout release ref
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.meta.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure release tag
        if: github.event_name == 'workflow_dispatch'
        env:
          TAG: ${{ steps.meta.outputs.tag }}
        run: |
          git fetch --tags --force
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            git checkout "tags/${TAG}" --detach
            echo "既存タグを利用します: ${TAG}"
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag "${TAG}"
            git push origin "refs/tags/${TAG}"
            git checkout "tags/${TAG}" --detach
            echo "タグを自動作成しました: ${TAG}"
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Validate signing secrets
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}
          ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          ANDROID_SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
        run: |
          for key in ANDROID_KEYSTORE_BASE64 ANDROID_SIGNING_STORE_PASSWORD ANDROID_SIGNING_KEY_ALIAS ANDROID_SIGNING_KEY_PASSWORD; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required secret: ${key}"
              exit 1
            fi
          done

      - name: Decode release keystore
        id: keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          KEYSTORE_PATH="${RUNNER_TEMP}/android-release.keystore"
          install -m 600 /dev/null "${KEYSTORE_PATH}"
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > "${KEYSTORE_PATH}"
          chmod 600 "${KEYSTORE_PATH}"
          echo "path=${KEYSTORE_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Build signed release APK
        working-directory: android
        env:
          ANDROID_SIGNING_STORE_FILE: ${{ steps.keystore.outputs.path }}
          ANDROID_SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}
          ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          ANDROID_SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
        run: ./gradlew :app:assembleRelease --no-daemon

      - name: Upload signed APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          generate_release_notes: true
          prerelease: ${{ steps.meta.outputs.prerelease }}
          files: android/app/build/outputs/apk/release/app-release.apk

      - name: Cleanup release keystore
        if: always()
        env:
          KEYSTORE_PATH: ${{ steps.keystore.outputs.path }}
        run: |
          if [ -n "${KEYSTORE_PATH}" ]; then
            rm -f "${KEYSTORE_PATH}"
          fi
